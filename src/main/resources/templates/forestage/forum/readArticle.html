<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<meta name="description" content="" />
	<meta name="author" content="" />
	<title>論壇讀取文章</title>
	<!-- Favicon-->
	<link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
	<!-- Bootstrap icons-->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
	<!-- Google font -->
	<link href="https://fonts.googleapis.com/css2?family=Ysabeau+SC&display=swap" rel="stylesheet">
	<!-- Core theme CSS (includes Bootstrap)-->
	<link th:href="@{/forestage/forum/mainPage/css/styles.css}" rel="stylesheet" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<style>
		.img-btn {
			border: none;
			background: transparent;
			padding: 0;
		}

		.img-btn img {
			max-width: 100%;
			height: auto;
		}
	</style>
</head>

<body class="d-flex flex-column h-100">
	<main class="flex-shrink-0">
		<!-- Navigation-->
		<div th:replace="~{forestage/shared/foreTopNav}"></div>

		<div class="container mt-5">
			<div class="row justify-content-center">
				<div class="col-lg-10">
					<!-- Post content-->
					<div class="card" style="position: relative;">
						<!-- Adding card and relative position for button group -->
						<article>
							<!-- Post header-->
							<header class="mb-4">
								<!-- Post title-->
								<h1 class="fw-bolder mb-1" th:text="${article.articleTitle}">Welcome to Blog Post!</h1>
								<!-- Post meta content-->
								<div class="text-muted fst-italic mb-2">
								</div>
								<!-- Post hashtags-->
								<th:block th:each="hashtag : ${#strings.arraySplit(article.hashtag, ' ')}">
									<a class="badge bg-secondary text-decoration-none link-light"
										th:href="'#!' + ${hashtag}" th:text="${hashtag}"></a>
								</th:block>
							</header>

							<!-- Preview image figure-->
							<figure class="mb-4">
								<img th:src="@{/forum/article/{articleId}/image(articleId=${article.articleId})}"
									alt="..." class="card-img1"
									style="object-fit: contain; width: 300px; height: 200px;" />
							</figure>
							<!-- Post content-->
							<section class="mb-5" th:utext="${article.articleContent}"></section>

							<!-- 喜歡與收藏數量 -->
							<p>Likes: <span th:text="${article.articleLikesCount}"></span></p>
							<p>Collected: <span th:text="${article.articleCollectCount}"></span></p>

						</article>
						<!-- Action buttons -->
						<div class="btn-group" role="group" aria-label="Basic example"
							style="position: absolute; bottom: 10px; right: 10px;">


							<button type="button" class="img-btn" id="likeButton"
								th:attr="onclick='toggleLike('+${article.articleId}+')'">
								<img th:src="@{/forestage/forum/readArticle/assets/like.png}" alt="Like button image">
							</button>

							<button type="button" class="img-btn" id="collectButton"
								th:attr="onclick='toggleCollect('+${article.articleId}+')'">
								<img th:src="@{/forestage/forum/readArticle/assets/collect.png}"
									alt="Collect button image">
							</button>

							<!-- Modal Trigger -->
							<button type="button" class="img-btn btn-danger" data-bs-toggle="modal"
								data-bs-target="#reportModal"
								th:attr="onclick='setCurrentArticleId('+${article.articleId}+')'">
								<img th:src="@{/forestage/forum/readArticle/assets/report.png}"
									alt="Report button image">
							</button>

							<!-- Modal -->
							<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel"
								aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="reportModalLabel">Report Article</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal"
												aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<label for="reportType">檢舉類型：</label>
											<select id="reportType" class="form-control">
												<option selected>請選擇...</option>

												<option value="spam">垃圾訊息</option>
												<option value="abuse">濫用或騷擾</option>
												<option value="false_information">虛假資訊</option>
												<option value="plagiarism">抄襲</option>
												<option value="other">其他</option>
											</select>

											<label for="reportContent">請輸入檢舉理由：</label>
											<textarea class="form-control" id="reportContent" rows="3"></textarea>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary"
												data-bs-dismiss="modal">關閉</button>
											<button type="button" class="btn btn-danger"
												onclick="reportArticle()">提交</button>
											<button id="autoFillReportButton">一鍵輸入檢舉</button>
										</div>

									</div>
								</div>
							</div>



						</div>
					</div>

					<!-- Comments section-->
					<section class="mb-5">
						<div class="card bg-light">
							<div class="card-body">
								<!-- Comment form-->
								<form id="comment-form" class="mb-4">
									<textarea id="comment-content" class="form-control" rows="3"
										placeholder="Join the discussion and leave a comment!"></textarea>

									<!-- Hidden input field for the article ID -->
									<input type="hidden" id="article-id" th:value="${article.articleId}" />

									<button type="submit" class="btn btn-primary mt-2">Submit</button>
								</form>

								<!-- Comment list -->
								<div id="comment-list">
								</div>
							</div>
						</div>
					</section>

				</div>
			</div>
		</div>
	</main>


	<!-- Bootstrap core JS-->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

	<script>
		function toggleLike(articleId) {
			axios.post(`/phocos/article/${articleId}/likes`)
				.then(function (response) {
					console.log(articleId);
					console.log(response.data);
					let heartParticles = document.getElementById('heartParticles');

					if (response.data) {  // 加入這個檢查以確保response.data存在
						var likeButton = document.getElementById('likeButton');
						if (response.data.isLiked == 1) {
							likeButton.classList.add('zoom-and-shake');
							setTimeout(() => {
								likeButton.classList.remove('zoom-and-shake');
							}, 500);
							swal("好的！", "已經加到 '我喜歡的文章'！", "success");  // 顯示彈出訊息
						} else {
							likeButton.classList.add('shrink-and-fade-effect');
							setTimeout(() => {
								likeButton.classList.remove('shrink-and-fade-effect');
							}, 500);
						}
					}
				})
				.catch(function (error) {
					console.log(error);
				});
		};
		// 對toggleCollect和reportArticle函數進行類似的修正
	</script>

	<script>
		function toggleCollect(articleId) {
			axios.post(`/phocos/article/${articleId}/collect`)
				.then(function (response) {
					console.log(articleId);
					console.log(response.data);
					if (response.data) {  // Add this check to ensure response.data exists
						var collectButton = document.getElementById('collectButton');
						if (response.data.isCollected == 1) {
							collectButton.classList.add('zoom-and-shake');
							setTimeout(() => {
								collectButton.classList.remove('zoom-and-shake');
							}, 500);
							swal("好的", "已經加到 '我收藏的文章'！", "success");  // Display alert message
						} else {
							collectButton.classList.add('shrink-and-fade-effect');
							setTimeout(() => {
								collectButton.classList.remove('shrink-and-fade-effect');
							}, 500);
						}
					}
				})
				.catch(function (error) {
					console.log(error);
				});
		};
	</script>


	<script>
		var currentArticleId = null;
		var reportModal = new bootstrap.Modal(document.getElementById('reportModal'));

		function setCurrentArticleId(articleId) {
			currentArticleId = articleId;
		}

		function reportArticle() {
			var reportContent = document.getElementById("reportContent").value;
			console.log(reportContent);
			var reportType = document.getElementById("reportType").value;

			var data = {
				"reportContent": reportContent,
				"reportType": reportType
			};

			axios.post(`/phocos/article/${currentArticleId}/report`, data)
				.then(function (response) {
					console.log(response.data);
					reportModal.hide();
				})
				.catch(function (error) {
					console.log(error);
				});
		}
	</script>

	<script>
		document.getElementById('autoFillReportButton').addEventListener('click', function () {
			// 檢舉類型
			document.getElementById('reportType').value = "plagiarism";
			// 檢舉理由
			document.getElementById('reportContent').value = "我在其他作者那邊看過一樣的文章";
		});
	</script>

	<!-- 回覆的 -->
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script>
		$(document).ready(function () {
			$('#comment-form').on('submit', function (event) {
				event.preventDefault();

				var commentContent = $('#comment-content').val();
				var articleId = $('#article-id').val();

				if (!articleId || isNaN(articleId)) {
					console.log('Invalid articleId:', articleId);
					return;
				}

				axios({
					method: 'post',
					url: '/phocos/comment/add',
					data: {
						articleId: articleId,
						commentContent: commentContent,
					},
					headers: {
						'Content-Type': 'application/json'
					}
				})
					.then(function (response) {
						console.log(response);
						// Append new comment to comment list
						$('#comment-list').append(`
						<div class="d-flex mb-4">
							<div class="flex-shrink-0"><img class="rounded-circle"
								src="https://dummyimage.com/50x50/ced4da/6c757d.jpg" alt="..." /></div>
							<div class="ms-3">
								<div class="fw-bold">Commenter Name</div>
								${commentContent}
							</div>
						</div>
					`);
						// Clear the comment content
						$('#comment-content').val('');
					})
					.catch(function (error) {
						console.log(error);
					});
			});
		});
	</script>


	// axios({
	// method: 'post',
	// url: '/phocos/comment/add',
	// params: {
	// articleId: articleId,
	// commentContent: commentContent,

	// },
	// })

</body>

</html>